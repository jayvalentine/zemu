require 'rake/testtask'
require 'rdoc/task'
require 'yard'

require 'fileutils'

# The location of this rakefile.
HERE = __dir__

task :test => 'test:all'

namespace :test do
    desc "Run config tests"
    Rake::TestTask.new :config do |t|
        t.test_files = FileList['test/config/test_*.rb']
    end

    desc "Run emulator tests"
    Rake::TestTask.new :emulator do |t|
        t.test_files = FileList['test/emulator/test_*.rb']
    end

    desc "Run build tests"
    Rake::TestTask.new :build do |t|
        t.test_files = FileList['test/build/test_*.rb']
    end

    desc "Run all tests"
    task :all => [:config, :build, :emulator]
end

task :docs => 'docs:build'

namespace :docs do
    desc "Generate documentation"
    task :build do
        system("rm -r #{File.join(HERE, "doc")}")
        
        output = `yardoc`

        unless /100.00% documented/ =~ output
            system("yard stats --list-undoc")
            puts ""
            abort("Aborting task due to missing documentation!")
        end
    end

    desc "View documentation"
    task :view => :build do
        system "firefox #{File.join(HERE, "doc", "index.html")}"
    end
end

namespace :release do
    def clean_gems
        Dir.glob("*.gem").each do |gem|
            FileUtils.rm(gem)
        end
    end

    desc "Release checklist"
    task :check => [:docs, :test]

    desc "Release a minor version"
    task :minor => :check do
        clean_gems

        gemspec = File.read(File.join(HERE, "zemu.gemspec"))

        minor = 0

        # Get the current minor version.
        m = gemspec.match(/MINOR = (\d+)/)
        if m.nil?
            abort("Could not determine minor version.")
        else
            minor = m[1].to_i
        end

        # Bump by 1.
        minor += 1

        gemspec.gsub!(/MINOR = \d+/, "MINOR = #{minor}")

        # Reset refresh number to 0.
        gemspec.gsub!(/REFRESH = \d+/, "REFRESH = 0")

        File.write("zemu.gemspec", gemspec)

        # Build the gem.
        system "gem build zemu.gemspec"
    end

    desc "Release a refresh version"
    task :refresh => :check do
        clean_gems

        gemspec = File.read(File.join(HERE, "zemu.gemspec"))

        refresh = 0

        # Get the current refresh version.
        m = gemspec.match(/REFRESH = (\d+)/)
        if m.nil?
            abort("Could not determine refresh version.")
        else
            refresh = m[1].to_i
        end

        # Bump by 1.
        refresh += 1

        gemspec.gsub!(/REFRESH = \d+/, "REFRESH = #{refresh}")

        File.write("zemu.gemspec", gemspec)

        # Build the gem.
        system "gem build zemu.gemspec"
    end
end
