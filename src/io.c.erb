#include "io.h"

<% io.each do |device| %>
<%= device.setup %>
<% end %>

zuint8 zemu_io_in(void * context, zuint16 port)
{
    /* Z80 IO ports occupy the lower half of the address bus.
     * We cannot assume that the top half is valid.
     */
    port &= 0x00FF;

<% io.each do |device| %>
<% if device.io_type == :serial %>
    if (port == <%= device.in_port %>)
    {
        return zemu_io_serial_slave_gets();
    }

    else if (port == <%= device.ready_port %>)
    {
        if (io_serial_buffer_master.head == io_serial_buffer_master.tail)
        {
            return 0;
        }
        else
        {
            return 1;
        }
    }
<% end %>
<% end %>
    return 0;
}

void zemu_io_out(void * context, zuint16 port, zuint8 value)
{
    /* Z80 IO ports occupy the lower half of the address bus.
     * We cannot assume that the top half is valid.
     */
    port &= 0x00FF;

<% io.each do |device| %>
<% if device.io_type == :serial %>
    if (port == <%= device.out_port %>)
    {
        zemu_io_serial_slave_puts(value);
    }
<% end %>
<% end %>
}
