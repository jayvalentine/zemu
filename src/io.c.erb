#include "io.h"

<% io.each do |device| %>
<% if device.io_type == :serial %>
SerialBuffer io_serial_<%= device.name %> = { .head = 0, .tail = 0 };
<% end %>
<% end %>

zuint8 zemu_io_serial_get(SerialBuffer * buffer)
{
    zuint8 val = buffer->buffer[buffer->head];
    buffer->head++;
    if (buffer->head >= ZEMU_IO_SERIAL_BUFFER_SIZE) buffer->head = 0;

    return val;
}

zuint8 zemu_io_in(void * context, zuint16 port)
{
    /* Z80 IO ports occupy the lower half of the address bus.
     * We cannot assume that the top half is valid.
     */
    port &= 0x00FF;

<% io.each do |device| %>
<% if device.io_type == :serial %>
    if (port == <%= device.in_port %>)
    {
        return zemu_io_serial_get(&io_serial_<%= device.name %>);
    }
<% end %>
<% end %>
    return 0;
}

void zemu_io_out(void * context, zuint16 port, zuint8 value)
{
    
}
